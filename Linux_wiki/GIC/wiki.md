
Linux内核设计与实现(原书第3版)

# 第(8) 章 下半部和推后执行的工作

中断处理程序是内核中很有用的〈实际上也是必不可少的) 部分。但是，由于本身存在一些局限，所以它只能完成整个中断处理流程的上半部分。这些局限包括 :  
。中断处理程序以异步方式执行, 并且它有可能会打断其他重要代码 (甚至包括其他中断处
理程序) 的执行。因此，为了避免被打断的代码停止时间过长，中断处理程序应该执行得
越快越好,
如果当前有一个中断处理程序正在执行，在最好的情况下 (如果 IRQF_DISABLED 设
有被设置 )，与该中断同级的其他中断会被屏藏，在最坏的情况下〈如果设置了IRQF
DISABLED), 当前处理器上所有其他中断都会被肝蔽。 因为禁止中断后硬件与操作系统
无法通信，因此，中断处理程序执行得越快越好。
由于中断处理程序往往需要对硬件进行操作，所以它们通常有很高的时限要求。
* 中断处理程序不在进程上下文中运行，所以它们不能阻塞。这限制了它们所做的事情。
现在，为什么中断处理程序只能作为整个硬件中断处理流程一部分的原因就很明显了。操作
系统必须有一个快速, 异步, 简单的机制负责对硬件做出迅速响应并完成那些时间要求很严格的
操作。中断处理程序很适合于实现这些功能，可是，对于那些其他的、对时间要求相对宽松的任
务, 就应该推后到中断被激活以后再去运行。

**记住，中断处理程序会异步执行，并且在最好的情况下它也会锁定当前的中断线. **

因此将中断处理程序持续执行的时间缩短到最小程度显得非常重要。

对于在上半部和下半部之间划分工作，尽管不存在某种严格的规则，但还是有一些提示可供借鉴:

如果一个任务**对时间非常敏感**, 将其放在中断处理程序中执行.

如果一个任务**和硬件相关**, 将其放在中断处理程序中执行.

如果一个任务**要保证不被其他中断 (特别是相同的中断) 打断**, 将其放在中断处理程序中执行,

其他所有任务, 考虑放置在下半部执行.

当你开始尝试写自己的驱动程序的时候, 读一下别人的中断处理程序和相应的下半部可能会让你受益匪浅, 在决定怎样把你的中断处理流程中的工作划分到上半部和下半部中去的时候,

问问自己什么必须放进上半部而什么可以放进下半部, 通常, 中断处理程序要执行得越快越好,









